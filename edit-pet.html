<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Pet - Happy Pets</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="stylesheet" href="styles.css?v=10">
  <link rel="stylesheet" href="forms.css?v=8">
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="pet-header" id="edit-header" style="background: linear-gradient(135deg, #7C9FE8 0%, #B8D4F1 100%);">
      <a href="index.html" class="back-button" id="back-button">‚Üê</a>
      <div class="pet-avatar" id="pet-avatar">üêæ</div>
      <h1 class="pet-name">Edit Pet</h1>
      <p class="pet-type" id="pet-type-display"></p>
    </header>

    <!-- Edit Pet Form -->
    <form id="edit-pet-form" class="form-section">
      <!-- Basic Info - Always visible -->
      <div class="form-group">
        <label for="pet-name">Pet's Name</label>
        <input type="text" id="pet-name" placeholder="What's their name?" required>
      </div>

      <div class="form-group">
        <label for="pet-breed">Breed (optional)</label>
        <input type="text" id="pet-breed" placeholder="e.g., Golden Retriever">
      </div>

      <!-- Add Tasks Section -->
      <div class="collapsible-section open">
        <button type="button" class="collapsible-header" onclick="toggleSection(this)">
          <span>‚ûï Add Tasks</span>
          <span class="collapse-icon">‚ñº</span>
        </button>
        <div class="collapsible-content">
          <p class="form-hint">Tap a task type to add it:</p>
          <div class="task-type-grid" id="task-type-grid">
            <button type="button" class="task-type-btn" onclick="openTaskForm('ü•£', 'Food', 'e.g., 1 cup of kibble')">
              <span class="task-type-icon">ü•£</span>
              <span class="task-type-label">Food</span>
            </button>
            <button type="button" class="task-type-btn" onclick="openTaskForm('üíß', 'Water', 'e.g., Fresh bowl')">
              <span class="task-type-icon">üíß</span>
              <span class="task-type-label">Water</span>
            </button>
            <button type="button" class="task-type-btn" onclick="openTaskForm('üö∂', 'Walk', 'e.g., 3 laps around block')">
              <span class="task-type-icon">üö∂</span>
              <span class="task-type-label">Walk</span>
            </button>
            <button type="button" class="task-type-btn" onclick="openTaskForm('üéæ', 'Play', 'e.g., 10 min fetch')">
              <span class="task-type-icon">üéæ</span>
              <span class="task-type-label">Play</span>
            </button>
            <button type="button" class="task-type-btn" onclick="openTaskForm('ü™•', 'Brush', 'e.g., Full coat')">
              <span class="task-type-icon">ü™•</span>
              <span class="task-type-label">Brush</span>
            </button>
            <button type="button" class="task-type-btn" onclick="openTaskForm('üßπ', 'Clean', 'e.g., Litter box')">
              <span class="task-type-icon">üßπ</span>
              <span class="task-type-label">Clean</span>
            </button>
            <button type="button" class="task-type-btn" onclick="openTaskForm('üíä', 'Medicine', 'e.g., 1 pill with food')">
              <span class="task-type-icon">üíä</span>
              <span class="task-type-label">Medicine</span>
            </button>
            <button type="button" class="task-type-btn" onclick="openTaskForm('üëÄ', 'Check', 'e.g., Eyes, ears, nose')">
              <span class="task-type-icon">üëÄ</span>
              <span class="task-type-label">Check</span>
            </button>
            <button type="button" class="task-type-btn" onclick="openTaskForm('üõÅ', 'Bath', 'e.g., Full wash')">
              <span class="task-type-icon">üõÅ</span>
              <span class="task-type-label">Bath</span>
            </button>
            <button type="button" class="task-type-btn" onclick="openTaskForm('‚úÇÔ∏è', 'Groom', 'e.g., Trim nails')">
              <span class="task-type-icon">‚úÇÔ∏è</span>
              <span class="task-type-label">Groom</span>
            </button>
            <button type="button" class="task-type-btn" onclick="openTaskForm('üöó', 'Trip', 'e.g., Vet visit')">
              <span class="task-type-icon">üöó</span>
              <span class="task-type-label">Trip</span>
            </button>
            <button type="button" class="task-type-btn" onclick="openTaskForm('üìå', 'Other', 'Describe the task')">
              <span class="task-type-icon">üìå</span>
              <span class="task-type-label">Other</span>
            </button>
          </div>

          <!-- Task Form Popup -->
          <div id="task-form-popup" class="task-form-popup" style="display: none;">
            <div class="task-form-header">
              <span id="task-form-icon" class="task-form-icon">ü•£</span>
              <span id="task-form-type" class="task-form-type">Food</span>
            </div>
            <div class="task-form-fields">
              <label>Task Name</label>
              <input type="text" id="task-form-name" placeholder="e.g., Breakfast">
              <label>Details <span class="optional">(optional)</span></label>
              <input type="text" id="task-form-details" placeholder="e.g., 1 cup of kibble">

              <label>Reminder Time <span class="optional">(optional)</span></label>
              <input type="time" id="task-form-time" placeholder="When should this be done?">

              <label>Schedule</label>
              <div class="schedule-toggle">
                <button type="button" class="schedule-btn active" data-value="daily" onclick="setSchedule('daily')">Daily</button>
                <button type="button" class="schedule-btn" data-value="weekly" onclick="setSchedule('weekly')">Certain days</button>
              </div>
              <input type="hidden" name="schedule" id="schedule-value" value="daily">

              <div id="day-picker" class="day-picker">
                <label class="day-option"><input type="checkbox" name="days" value="0"><span>Sun</span></label>
                <label class="day-option"><input type="checkbox" name="days" value="1"><span>Mon</span></label>
                <label class="day-option"><input type="checkbox" name="days" value="2"><span>Tue</span></label>
                <label class="day-option"><input type="checkbox" name="days" value="3"><span>Wed</span></label>
                <label class="day-option"><input type="checkbox" name="days" value="4"><span>Thu</span></label>
                <label class="day-option"><input type="checkbox" name="days" value="5"><span>Fri</span></label>
                <label class="day-option"><input type="checkbox" name="days" value="6"><span>Sat</span></label>
              </div>

              <div class="form-group" style="margin-top: 12px;">
                <label class="toggle-label">
                  <input type="checkbox" id="task-requires-approval" name="requiresApproval">
                  <span class="toggle-switch"></span>
                  <span class="toggle-text">Needs Parent OK</span>
                </label>
                <p class="form-hint" style="margin-top: 4px; font-size: 11px;">Parents must approve when kids complete this task</p>
              </div>
            </div>
            <div class="task-form-buttons">
              <button type="button" class="task-form-cancel" onclick="closeTaskForm()">Cancel</button>
              <button type="button" class="task-form-add" onclick="submitTaskForm()">Add Task</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Current Tasks List -->
      <div class="collapsible-section open" id="current-tasks-section">
        <button type="button" class="collapsible-header" onclick="toggleSection(this)">
          <span>üìã Current Tasks</span>
          <span class="collapse-icon">‚ñº</span>
        </button>
        <div class="collapsible-content">
          <div id="tasks-list" class="tasks-list">
            <p class="empty-tasks">No tasks yet. Tap a task type above to add one.</p>
          </div>
        </div>
      </div>

      <!-- Collapsible: Task Order -->
      <div class="collapsible-section" id="task-order-section" style="display: none;">
        <button type="button" class="collapsible-header" onclick="toggleSection(this)">
          <span>‚ÜïÔ∏è Reorder Tasks</span>
          <span class="collapse-icon">‚ñº</span>
        </button>
        <div class="collapsible-content">
          <p class="form-hint">Use arrows to change order</p>
          <div id="task-order-list" class="task-order-list">
            <!-- Ordered tasks rendered by JavaScript -->
          </div>
        </div>
      </div>

      <button type="submit" class="submit-button" disabled>
        <span>Loading...</span>
        <span class="button-icon">‚Üê</span>
      </button>

      <button type="button" class="delete-button" onclick="confirmDelete()">
        Remove This Pet
      </button>
    </form>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
      <a href="index.html" class="nav-item">
        <span class="nav-icon">üè†</span>
        <span class="nav-label">Home</span>
      </a>
      <a href="today.html" class="nav-item">
        <span class="nav-icon">üìÖ</span>
        <span class="nav-label">Today</span>
      </a>
      <a href="memories.html" class="nav-item">
        <span class="nav-icon">üì∏</span>
        <span class="nav-label">Memories</span>
      </a>
      <a href="family.html" class="nav-item">
        <span class="nav-icon">üë®‚Äçüë©‚Äçüëß</span>
        <span class="nav-label">Family</span>
      </a>
    </nav>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js?v=3"></script>
  <script src="app.js?v=8"></script>
  <script>
    // Collapsible sections
    function toggleSection(button) {
      const section = button.closest('.collapsible-section');
      section.classList.toggle('open');
    }

    let currentPetId = null;
    let tasks = []; // All tasks are now stored here
    let currentFormIcon = '';
    let currentFormType = '';
    let editingTaskId = null; // Track if we're editing an existing task

    // Check auth
    if (!requireAuth()) {
      // Redirect handled by requireAuth
    } else {
      initAsync();
    }

    async function initAsync() {
      try {
        currentPetId = getUrlParam('id');
        if (!currentPetId || currentPetId.trim() === '') {
          window.location.href = 'index.html';
          return;
        }

        const pet = await getPetFromFirestore(currentPetId);
        if (!pet) {
          window.location.href = 'index.html';
          return;
        }

        // Set back button to return to pet view
        document.getElementById('back-button').href = `pet-view.html?id=${currentPetId}`;

        // Update header
        const config = PET_CONFIG[pet.type] || PET_CONFIG.dog;
        document.getElementById('edit-header').style.background =
          `linear-gradient(135deg, ${config.color} 0%, ${lightenColor(config.color)} 100%)`;
        document.getElementById('pet-avatar').textContent = config.emoji;
        document.getElementById('pet-type-display').textContent = config.name;

        // Fill in form fields
        document.getElementById('pet-name').value = pet.name;
        document.getElementById('pet-breed').value = pet.breed || '';

        // Load tasks - now all tasks are in customTasks
        tasks = pet.customTasks || [];

        renderTasksList();
        renderTaskOrderList();

        // Enable save button now that pet is loaded
        const submitBtn = document.querySelector('.submit-button');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<span>Done</span><span class="button-icon">‚Üê</span>';
      } catch (error) {
        console.error('Error loading pet:', error);
        alert('Error loading pet: ' + error.message);
      }
    }

    // ============================================
    // TASK FORM POPUP
    // ============================================

    function openTaskForm(icon, type, placeholder) {
      editingTaskId = null; // New task, not editing
      currentFormIcon = icon;
      currentFormType = type;

      document.getElementById('task-form-icon').textContent = icon;
      document.getElementById('task-form-type').textContent = type;
      document.getElementById('task-form-name').placeholder = type;
      document.getElementById('task-form-name').value = '';
      document.getElementById('task-form-details').placeholder = placeholder;
      document.getElementById('task-form-details').value = '';
      const addBtn = document.querySelector('.task-form-add');
      addBtn.textContent = 'Add Task';
      addBtn.disabled = false;

      // Reset schedule to daily
      setSchedule('daily');
      document.querySelectorAll('input[name="days"]').forEach(cb => cb.checked = false);
      document.getElementById('task-requires-approval').checked = false;
      document.getElementById('task-form-time').value = '';

      document.getElementById('task-form-popup').style.display = 'block';
      document.getElementById('task-form-name').focus();
    }

    function editTask(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;

      editingTaskId = taskId;
      currentFormIcon = task.icon;
      currentFormType = task.name;

      document.getElementById('task-form-icon').textContent = task.icon;
      document.getElementById('task-form-type').textContent = 'Edit Task';
      document.getElementById('task-form-name').placeholder = 'Task name';
      document.getElementById('task-form-name').value = task.name;
      document.getElementById('task-form-details').placeholder = 'Details';
      document.getElementById('task-form-details').value = task.details || '';
      const addBtn = document.querySelector('.task-form-add');
      addBtn.textContent = 'Save Changes';
      addBtn.disabled = false;

      // Set schedule
      setSchedule(task.schedule === 'weekly' ? 'weekly' : 'daily');

      // Set days
      document.querySelectorAll('input[name="days"]').forEach(cb => {
        cb.checked = task.days && task.days.includes(parseInt(cb.value));
      });

      // Set approval toggle
      document.getElementById('task-requires-approval').checked = task.requiresApproval || false;

      // Set time
      document.getElementById('task-form-time').value = task.reminderTime || '';

      document.getElementById('task-form-popup').style.display = 'block';
      document.getElementById('task-form-name').focus();
    }

    function closeTaskForm() {
      document.getElementById('task-form-popup').style.display = 'none';
      editingTaskId = null;
    }

    function setSchedule(value) {
      document.getElementById('schedule-value').value = value;
      document.querySelectorAll('.schedule-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.value === value);
      });
      document.getElementById('day-picker').classList.toggle('visible', value === 'weekly');
    }

    function toggleDayPicker() {
      const isWeekly = document.getElementById('schedule-value').value === 'weekly';
      document.getElementById('day-picker').classList.toggle('visible', isWeekly);
    }

    async function submitTaskForm() {
      const nameInput = document.getElementById('task-form-name');
      const detailsInput = document.getElementById('task-form-details');
      const addBtn = document.querySelector('.task-form-add');

      const name = nameInput.value.trim() || currentFormType;
      const details = detailsInput.value.trim() || 'Tap when done!';

      // Get schedule
      const schedule = document.getElementById('schedule-value').value;
      const dayCheckboxes = document.querySelectorAll('input[name="days"]:checked');
      const days = Array.from(dayCheckboxes).map(cb => parseInt(cb.value));
      const requiresApproval = document.getElementById('task-requires-approval').checked;
      const reminderTime = document.getElementById('task-form-time').value || '';

      if (editingTaskId) {
        // Update existing task
        const task = tasks.find(t => t.id === editingTaskId);
        if (task) {
          task.name = name;
          task.details = details;
          task.schedule = schedule;
          task.days = schedule === 'weekly' ? days : [];
          task.requiresApproval = requiresApproval;
          task.reminderTime = reminderTime;
        }
      } else {
        // Create new task
        const id = 'task_' + Date.now();
        tasks.push({
          id,
          icon: currentFormIcon,
          name,
          details,
          schedule,
          days: schedule === 'weekly' ? days : [],
          requiresApproval,
          reminderTime
        });
      }

      // Auto-save to Firestore
      addBtn.textContent = 'Saving...';
      addBtn.disabled = true;
      try {
        const taskIds = tasks.map(t => t.id);
        await updatePetInFirestore(currentPetId, {
          tasks: taskIds,
          customTasks: tasks
        });
        renderTasksList();
        renderTaskOrderList();
        closeTaskForm();
      } catch (error) {
        alert('Error saving: ' + error.message);
        addBtn.textContent = editingTaskId ? 'Save Changes' : 'Add Task';
        addBtn.disabled = false;
      }
    }

    // ============================================
    // TASKS LIST
    // ============================================

    const DAY_NAMES = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

    function formatTime(time24) {
      if (!time24) return '';
      const [hours, minutes] = time24.split(':').map(Number);
      const ampm = hours >= 12 ? 'PM' : 'AM';
      const hours12 = hours % 12 || 12;
      return `${hours12}:${minutes.toString().padStart(2, '0')} ${ampm}`;
    }

    function getScheduleLabel(task) {
      if (!task.schedule || task.schedule === 'daily') {
        return 'Daily';
      }
      if (task.days && task.days.length > 0) {
        return task.days.map(d => DAY_NAMES[d]).join(', ');
      }
      return 'No days selected';
    }

    function renderTasksList() {
      const container = document.getElementById('tasks-list');

      if (tasks.length === 0) {
        container.innerHTML = '<p class="empty-tasks">No tasks yet. Tap a task type above to add one.</p>';
        return;
      }

      let html = '';
      tasks.forEach((task, index) => {
        const scheduleLabel = getScheduleLabel(task);
        const approvalBadge = task.requiresApproval ? '<span class="approval-badge">Needs OK</span>' : '';
        const timeLabel = task.reminderTime ? `‚è∞ ${formatTime(task.reminderTime)}` : '';
        html += `
          <div class="task-list-item">
            <span class="task-list-icon">${task.icon}</span>
            <div class="task-list-info" onclick="editTask('${task.id}')">
              <div class="task-list-name">${escapeHtml(task.name)}${approvalBadge}</div>
              <div class="task-list-details">${escapeHtml(task.details || 'Tap when done!')}</div>
              <div class="task-list-schedule">üìÖ ${scheduleLabel}${timeLabel ? ' ‚Ä¢ ' + timeLabel : ''}</div>
            </div>
            <button type="button" class="task-edit-btn" onclick="editTask('${task.id}')">‚úé</button>
            <button type="button" class="task-delete-btn" onclick="deleteTask('${task.id}')">√ó</button>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    async function deleteTask(taskId) {
      if (!confirm('Delete this task?')) return;

      tasks = tasks.filter(t => t.id !== taskId);
      renderTasksList();
      renderTaskOrderList();

      // Auto-save
      try {
        const taskIds = tasks.map(t => t.id);
        await updatePetInFirestore(currentPetId, {
          tasks: taskIds,
          customTasks: tasks
        });
      } catch (error) {
        alert('Error saving: ' + error.message);
      }
    }

    // ============================================
    // TASK REORDERING
    // ============================================

    function renderTaskOrderList() {
      const container = document.getElementById('task-order-list');
      const section = document.getElementById('task-order-section');

      if (tasks.length < 2) {
        section.style.display = 'none';
        return;
      }

      section.style.display = 'block';
      section.classList.add('open');

      let html = '';
      tasks.forEach((task, index) => {
        html += `
          <div class="task-order-item">
            <span class="task-order-icon">${task.icon}</span>
            <span class="task-order-name">${escapeHtml(task.name)}</span>
            <div class="task-order-buttons">
              <button type="button" class="order-btn" onclick="moveTask(${index}, -1)" ${index === 0 ? 'disabled' : ''}>‚ñ≤</button>
              <button type="button" class="order-btn" onclick="moveTask(${index}, 1)" ${index === tasks.length - 1 ? 'disabled' : ''}>‚ñº</button>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    async function moveTask(index, direction) {
      const newIndex = index + direction;
      if (newIndex < 0 || newIndex >= tasks.length) return;

      // Swap
      [tasks[index], tasks[newIndex]] = [tasks[newIndex], tasks[index]];
      renderTasksList();
      renderTaskOrderList();

      // Auto-save
      try {
        const taskIds = tasks.map(t => t.id);
        await updatePetInFirestore(currentPetId, {
          tasks: taskIds,
          customTasks: tasks
        });
      } catch (error) {
        alert('Error saving: ' + error.message);
      }
    }

    // ============================================
    // FORM SUBMISSION
    // ============================================

    async function confirmDelete() {
      if (confirm('Are you sure you want to remove this pet? This cannot be undone.')) {
        await deletePetFromFirestore(currentPetId);
        window.location.href = 'today.html';
      }
    }

    // Auto-save name and breed on blur
    document.getElementById('pet-name').addEventListener('blur', autoSaveBasicInfo);
    document.getElementById('pet-breed').addEventListener('blur', autoSaveBasicInfo);

    async function autoSaveBasicInfo() {
      const name = document.getElementById('pet-name').value.trim();
      const breed = document.getElementById('pet-breed').value.trim();
      if (!name) return; // Don't save empty name

      try {
        await updatePetInFirestore(currentPetId, { name, breed });
      } catch (error) {
        console.error('Error auto-saving:', error);
      }
    }

    // Done button - just navigate back (everything auto-saves)
    document.getElementById('edit-pet-form').addEventListener('submit', function(e) {
      e.preventDefault();
      window.location.href = `pet-view.html?id=${currentPetId}`;
    });
  </script>
</body>
</html>
