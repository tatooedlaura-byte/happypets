<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Today - Happy Pets</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="stylesheet" href="styles.css?v=20">
  <link rel="stylesheet" href="forms.css?v=20">
</head>
<body>
  <div class="app">
    <!-- Header with Progress -->
    <header class="header today-header" id="today-summary">
      <div class="today-header-content">
        <div class="today-header-left">
          <h1>üìÖ Today's Tasks</h1>
          <p class="subtitle" id="today-date"></p>
        </div>
        <div class="today-progress">
          <span class="progress-count" id="completed-count">0</span>
          <span class="progress-total">/<span id="total-count">0</span></span>
          <span class="progress-label">done</span>
        </div>
      </div>
      <div class="user-switcher">
        <select id="user-dropdown" class="user-dropdown" onchange="switchUser(this.value)">
          <option value="">Who's doing tasks?</option>
        </select>
      </div>
    </header>

    <!-- All Tasks -->
    <main class="today-tasks" id="today-tasks">
      <div class="loading-state">
        <p>Loading tasks...</p>
      </div>
    </main>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
      <a href="index.html" class="nav-item">
        <span class="nav-icon">üè†</span>
        <span class="nav-label">Home</span>
      </a>
      <a href="today.html" class="nav-item active">
        <span class="nav-icon">üìÖ</span>
        <span class="nav-label">Today</span>
      </a>
      <a href="#" class="nav-item">
        <span class="nav-icon">üì∏</span>
        <span class="nav-label">Memories</span>
      </a>
      <a href="family.html" class="nav-item">
        <span class="nav-icon">üë®‚Äçüë©‚Äçüëß</span>
        <span class="nav-label">Family</span>
      </a>
    </nav>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js?v=20"></script>
  <script src="app.js?v=20"></script>
  <script>
    // Check auth
    if (!requireAuth()) {
      // Redirect handled by requireAuth
    } else {
      init();
    }

    // Format today's date nicely
    function formatDate() {
      const options = { weekday: 'long', month: 'long', day: 'numeric' };
      return new Date().toLocaleDateString('en-US', options);
    }

    let membersData = [];

    async function init() {
      document.getElementById('today-date').textContent = formatDate();
      await loadUserDropdown();
      await renderTodayTasksAsync();
    }

    async function loadUserDropdown() {
      membersData = await getMembers();
      const dropdown = document.getElementById('user-dropdown');
      const currentMember = getCurrentMember();

      let html = '<option value="">Who\'s doing tasks?</option>';
      membersData.forEach(member => {
        const isSelected = currentMember && currentMember.id === member.id;
        html += `<option value="${member.id}" ${isSelected ? 'selected' : ''}>${member.avatar} ${member.name}</option>`;
      });

      dropdown.innerHTML = html;
    }

    function switchUser(memberId) {
      if (!memberId) return;

      const member = membersData.find(m => m.id === memberId);
      if (member) {
        setCurrentMember(member.id, member.name, member.avatar, member.isParent || false);
        // Refresh the page to show tasks with new user
        location.reload();
      }
    }

    // Render all tasks for all pets
    async function renderTodayTasksAsync() {
      const container = document.getElementById('today-tasks');
      const pets = await getPetsFromFirestore();

      if (pets.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <p>No pets yet!</p>
            <a href="add-pet.html" class="add-pet-link">Add your first pet</a>
          </div>
        `;
        return;
      }

      let html = '';
      let totalTasks = 0;
      let completedTasks = 0;

      for (const pet of pets) {
        const config = PET_CONFIG[pet.type] || PET_CONFIG.dog;
        const customTasks = pet.customTasks || [];

        if (!pet.tasks || pet.tasks.length === 0) continue;

        let petTasksHtml = '';
        let petHasTasks = false;

        for (const taskId of pet.tasks) {
          // Find task in customTasks array (new format)
          const taskData = customTasks.find(ct => ct.id === taskId);

          if (!taskData) {
            // Legacy support: check old TASK_CONFIG
            const legacyTask = TASK_CONFIG[taskId];
            if (!legacyTask) continue;

            petHasTasks = true;
            totalTasks++;
            const completion = await getTaskCompletionDetails(pet.id, taskId);
            const isComplete = !!completion;
            if (isComplete) completedTasks++;

            const hintText = (pet.taskHints && pet.taskHints[taskId]) || legacyTask.time;
            const doneText = isComplete ? `Done by ${completion.completedByName || 'someone'} ‚ú®` : escapeHtml(hintText);

            petTasksHtml += `
              <button class="task-button ${isComplete ? 'completed' : ''}"
                      data-task-id="${taskId}"
                      data-hint="${escapeHtml(hintText)}"
                      onclick="handleTodayTaskClick(this, '${pet.id}', '${taskId}')">
                <div class="task-icon">${legacyTask.icon}</div>
                <div class="task-content">
                  <div class="task-name">${escapeHtml(legacyTask.name)}</div>
                  <div class="task-time">${doneText}</div>
                </div>
                <div class="task-check">${isComplete ? '‚úì' : ''}</div>
              </button>
            `;
            continue;
          }

          // Check if task should show today
          if (!shouldShowTaskToday(taskData)) continue;

          petHasTasks = true;
          totalTasks++;
          const completion = await getTaskCompletionDetails(pet.id, taskId);
          const isComplete = !!completion;
          if (isComplete) completedTasks++;

          const hint = taskData.details || 'Tap when done!';
          const reminderTime = taskData.reminderTime || '';
          const timeDisplay = reminderTime ? formatTime(reminderTime) : '';
          const overdue = !isComplete && isTaskOverdue(reminderTime);

          let statusText = escapeHtml(hint);
          let statusClass = isComplete ? 'completed' : (overdue ? 'overdue' : '');

          if (isComplete) {
            statusText = `Done by ${completion.completedByName || 'someone'} ‚ú®`;
          } else if (overdue) {
            statusText = `‚ö†Ô∏è Overdue! Was due at ${timeDisplay}`;
          } else if (timeDisplay) {
            statusText = `‚è∞ ${timeDisplay} ‚Ä¢ ${escapeHtml(hint)}`;
          }

          petTasksHtml += `
            <button class="task-button ${statusClass}"
                    data-task-id="${taskId}"
                    data-hint="${escapeHtml(hint)}"
                    data-reminder-time="${reminderTime}"
                    onclick="handleTodayTaskClick(this, '${pet.id}', '${taskId}')">
              <div class="task-icon">${taskData.icon}</div>
              <div class="task-content">
                <div class="task-name">${escapeHtml(taskData.name)}</div>
                <div class="task-time">${statusText}</div>
              </div>
              <div class="task-check">${isComplete ? '‚úì' : ''}</div>
            </button>
          `;
        }

        if (petHasTasks) {
          html += `
            <div class="pet-task-group">
              <div class="pet-task-header">
                <span class="pet-task-avatar" style="background: ${config.color}">${config.emoji}</span>
                <span class="pet-task-name">${escapeHtml(pet.name)}</span>
              </div>
              <div class="pet-task-list">
                ${petTasksHtml}
              </div>
            </div>
          `;
        }
      }

      if (html === '') {
        html = `
          <div class="empty-state">
            <p>No tasks scheduled for today!</p>
          </div>
        `;
      }

      container.innerHTML = html;

      // Update summary
      document.getElementById('completed-count').textContent = completedTasks;
      document.getElementById('total-count').textContent = totalTasks;

      // Update header color when all done
      const summaryEl = document.getElementById('today-summary');
      if (totalTasks > 0 && completedTasks === totalTasks) {
        summaryEl.classList.add('all-done');
      } else {
        summaryEl.classList.remove('all-done');
      }
    }

    // Handle task click from Today view - optimistic UI update
    async function handleTodayTaskClick(buttonEl, petId, taskId) {
      const wasComplete = buttonEl.classList.contains('completed');
      const wasOverdue = buttonEl.classList.contains('overdue');
      const isNowComplete = !wasComplete;

      // Toggle visual state immediately
      buttonEl.classList.remove('completed', 'overdue');
      if (isNowComplete) {
        buttonEl.classList.add('completed');
      }

      const timeEl = buttonEl.querySelector('.task-time');
      const checkEl = buttonEl.querySelector('.task-check');
      const hint = buttonEl.dataset.hint;
      const reminderTime = buttonEl.dataset.reminderTime || '';
      const timeDisplay = reminderTime ? formatTime(reminderTime) : '';

      if (isNowComplete) {
        timeEl.textContent = 'Done! ‚ú®';
        checkEl.textContent = '‚úì';
        showCelebration();
      } else {
        // Check if it should show as overdue
        const overdue = isTaskOverdue(reminderTime);
        if (overdue) {
          buttonEl.classList.add('overdue');
          timeEl.textContent = `‚ö†Ô∏è Overdue! Was due at ${timeDisplay}`;
        } else if (timeDisplay) {
          timeEl.textContent = `‚è∞ ${timeDisplay} ‚Ä¢ ${hint}`;
        } else {
          timeEl.textContent = hint;
        }
        checkEl.textContent = '';
      }

      // Update counter immediately
      const completedEl = document.getElementById('completed-count');
      const totalEl = document.getElementById('total-count');
      let completed = parseInt(completedEl.textContent);
      const total = parseInt(totalEl.textContent);

      if (isNowComplete) {
        completed++;
      } else {
        completed--;
      }
      completedEl.textContent = completed;

      // Update header color
      const summaryEl = document.getElementById('today-summary');
      if (total > 0 && completed === total) {
        summaryEl.classList.add('all-done');
      } else {
        summaryEl.classList.remove('all-done');
      }

      // Save to Firestore in background
      toggleTaskInFirestore(petId, taskId).catch(err => {
        console.error('Error saving task:', err);
        // Revert on error
        buttonEl.classList.remove('completed', 'overdue');
        if (wasComplete) {
          buttonEl.classList.add('completed');
          timeEl.textContent = 'Done! ‚ú®';
          checkEl.textContent = '‚úì';
        } else if (wasOverdue) {
          buttonEl.classList.add('overdue');
          timeEl.textContent = `‚ö†Ô∏è Overdue! Was due at ${timeDisplay}`;
        } else if (timeDisplay) {
          timeEl.textContent = `‚è∞ ${timeDisplay} ‚Ä¢ ${hint}`;
        } else {
          timeEl.textContent = hint;
        }
        completedEl.textContent = wasComplete ? completed + 1 : completed - 1;
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatTime(time24) {
      if (!time24) return '';
      const [hours, minutes] = time24.split(':').map(Number);
      const ampm = hours >= 12 ? 'PM' : 'AM';
      const hours12 = hours % 12 || 12;
      return `${hours12}:${minutes.toString().padStart(2, '0')} ${ampm}`;
    }

    function isTaskOverdue(reminderTime) {
      if (!reminderTime) return false;
      const now = new Date();
      const [hours, minutes] = reminderTime.split(':').map(Number);
      const taskTime = new Date();
      taskTime.setHours(hours, minutes, 0, 0);
      return now > taskTime;
    }
  </script>
</body>
</html>
