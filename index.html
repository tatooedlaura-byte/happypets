<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Happy Pets</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="stylesheet" href="styles.css?v=8">
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <h1>ğŸ¾ Happy Pets</h1>
      <p class="subtitle" id="family-subtitle">Your furry friends need you!</p>
      <a href="family.html" class="current-user-badge" id="current-user-badge" title="Tap to switch user">
        <span class="current-user-avatar" id="current-user-avatar">ğŸ‘¤</span>
        <span class="current-user-name" id="current-user-name">Select who you are</span>
      </a>
    </header>

    <!-- Loading State -->
    <div id="loading-state" class="loading-state">
      <p>Loading your pets...</p>
    </div>

    <!-- Pending Approvals (for parents) -->
    <section class="approvals-section" id="approvals-section" style="display: none;">
      <h2>â³ Waiting for Your OK</h2>
      <div id="approvals-list"></div>
    </section>

    <!-- Pet Cards (rendered dynamically) -->
    <main class="pet-grid" id="pet-cards-container" style="display: none;">
      <!-- Pets will be loaded here by JavaScript -->
    </main>

    <!-- Kindness Jar -->
    <section class="kindness-section" id="kindness-section" style="display: none;">
      <h2>Your Kindness Jar</h2>
      <div class="kindness-jar">
        <div class="jar-container">
          <div class="jar-fill" id="jar-fill" style="height: 5%;">
            <span class="heart">ğŸ’–</span>
            <span class="heart">ğŸ’•</span>
            <span class="heart">ğŸ’—</span>
            <span class="paw">ğŸ¾</span>
            <span class="star">â­</span>
            <span class="heart">ğŸ’–</span>
          </div>
        </div>
        <p class="jar-message" id="jar-message">Let's help our pets today!</p>
      </div>
    </section>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
      <a href="index.html" class="nav-item active">
        <span class="nav-icon">ğŸ </span>
        <span class="nav-label">Home</span>
      </a>
      <a href="today.html" class="nav-item">
        <span class="nav-icon">ğŸ“…</span>
        <span class="nav-label">Today</span>
      </a>
      <a href="#" class="nav-item">
        <span class="nav-icon">ğŸ“¸</span>
        <span class="nav-label">Memories</span>
      </a>
      <a href="family.html" class="nav-item">
        <span class="nav-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</span>
        <span class="nav-label">Family</span>
      </a>
    </nav>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="app.js?v=7"></script>
  <script>
    // Check auth
    if (!requireAuth()) {
      // Redirect handled by requireAuth
    } else {
      initHomePage();
    }

    async function initHomePage() {
      const family = getCurrentFamily();
      if (family) {
        document.getElementById('family-subtitle').textContent = family.name;
      }

      // Show current user
      updateCurrentUserBadge();

      await renderPetCardsAsync();
      await renderKindnessJarAsync();
      await renderPendingApprovals();

      // Show content, hide loading
      document.getElementById('loading-state').style.display = 'none';
      document.getElementById('pet-cards-container').style.display = 'grid';
      document.getElementById('kindness-section').style.display = 'block';
    }

    async function renderPendingApprovals() {
      const member = getCurrentMember();
      const approvalsSection = document.getElementById('approvals-section');
      const approvalsList = document.getElementById('approvals-list');

      // Only show for parents
      if (!member || !member.isParent) {
        approvalsSection.style.display = 'none';
        return;
      }

      try {
        const pending = await getPendingApprovals();

        if (pending.length === 0) {
          approvalsSection.style.display = 'none';
          return;
        }

        // Get pet names for display
        const pets = await getPetsFromFirestore();
        const petMap = {};
        pets.forEach(p => petMap[p.id] = p);

        let html = '';
        for (const item of pending) {
          const pet = petMap[item.petId];
          const petName = pet ? pet.name : 'Unknown Pet';

          // Try to get task name
          let taskName = item.taskId;
          if (pet && pet.customTasks) {
            const task = pet.customTasks.find(t => t.id === item.taskId);
            if (task) taskName = task.name;
          }
          // Check legacy tasks
          if (typeof TASK_CONFIG !== 'undefined' && TASK_CONFIG[item.taskId]) {
            taskName = TASK_CONFIG[item.taskId].name;
          }

          html += `
            <div class="approval-item" id="approval-${item.id}">
              <div class="approval-info">
                <div class="approval-task">${escapeHtml(taskName)}</div>
                <div class="approval-by">${escapeHtml(item.completedByName)} â€¢ ${escapeHtml(petName)}</div>
              </div>
              <div class="approval-actions">
                <button class="approve-btn" onclick="handleApprove('${item.id}')" title="Approve">âœ“</button>
                <button class="reject-btn" onclick="handleReject('${item.id}')" title="Reject">âœ—</button>
              </div>
            </div>
          `;
        }

        approvalsList.innerHTML = html;
        approvalsSection.style.display = 'block';

      } catch (error) {
        console.error('Error loading approvals:', error);
        approvalsSection.style.display = 'none';
      }
    }

    async function handleApprove(completionId) {
      const item = document.getElementById(`approval-${completionId}`);
      if (item) item.style.opacity = '0.5';

      try {
        await approveTask(completionId);
        if (item) item.remove();

        // Check if any approvals left
        const list = document.getElementById('approvals-list');
        if (list && list.children.length === 0) {
          document.getElementById('approvals-section').style.display = 'none';
        }

        // Refresh kindness jar
        await renderKindnessJarAsync();
      } catch (error) {
        console.error('Error approving:', error);
        if (item) item.style.opacity = '1';
        alert('Error approving task');
      }
    }

    async function handleReject(completionId) {
      if (!confirm('Reject this task? The helper will need to do it again.')) return;

      const item = document.getElementById(`approval-${completionId}`);
      if (item) item.style.opacity = '0.5';

      try {
        await rejectTask(completionId);
        if (item) item.remove();

        // Check if any approvals left
        const list = document.getElementById('approvals-list');
        if (list && list.children.length === 0) {
          document.getElementById('approvals-section').style.display = 'none';
        }
      } catch (error) {
        console.error('Error rejecting:', error);
        if (item) item.style.opacity = '1';
        alert('Error rejecting task');
      }
    }

    async function renderPetCardsAsync() {
      const container = document.getElementById('pet-cards-container');
      let pets;
      try {
        pets = await getPetsFromFirestore();
        console.log('Loaded pets:', pets);
      } catch (error) {
        console.error('Error loading pets:', error);
        pets = [];
      }

      let html = '';

      for (const pet of pets) {
        const config = PET_CONFIG[pet.type] || PET_CONFIG.dog;
        const completedTasks = await getCompletedTasksForPetFromFirestore(pet.id);
        const totalTasks = pet.tasks ? pet.tasks.length : 0;
        const allDone = completedTasks >= totalTasks && totalTasks > 0;

        html += `
          <a href="pet-view.html?id=${pet.id}" class="pet-card">
            <div class="pet-avatar" style="background: ${config.color}">${config.emoji}</div>
            <h2 class="pet-name">${escapeHtml(pet.name)}</h2>
            <p class="pet-type">${pet.breed || config.name}</p>
            <div class="pet-status">
              <span class="status-dot ${allDone ? 'done' : 'pending'}"></span>
              <span>${completedTasks} of ${totalTasks} done</span>
            </div>
          </a>
        `;
      }

      // Add Pet card
      html += `
        <a href="add-pet.html" class="pet-card add-pet">
          <div class="pet-avatar add">+</div>
          <h2 class="pet-name">Add Pet</h2>
          <p class="pet-type">Tap to add a new friend</p>
        </a>
      `;

      container.innerHTML = html;
    }

    async function renderKindnessJarAsync() {
      const jarFill = document.getElementById('jar-fill');
      const jarMessage = document.getElementById('jar-message');
      if (!jarFill) return;

      const kindness = await getKindnessFromFirestore();
      const level = getKindnessLevel(kindness);

      jarFill.style.height = level + '%';

      // Update message based on level
      if (jarMessage) {
        if (level < 25) {
          jarMessage.textContent = "Let's help our pets today!";
        } else if (level < 50) {
          jarMessage.textContent = "You're doing great!";
        } else if (level < 75) {
          jarMessage.textContent = "So much kindness!";
        } else {
          jarMessage.textContent = "Amazing helper!";
        }
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function updateCurrentUserBadge() {
      const member = getCurrentMember();
      const avatarEl = document.getElementById('current-user-avatar');
      const nameEl = document.getElementById('current-user-name');

      if (member) {
        avatarEl.textContent = member.avatar;
        nameEl.textContent = member.name;
      } else {
        avatarEl.textContent = 'ğŸ‘¤';
        nameEl.textContent = 'Tap to pick yourself';
      }
    }
  </script>
</body>
</html>
