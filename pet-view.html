<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pet Care - Happy Pets</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="stylesheet" href="styles.css?v=9">
</head>
<body>
  <div class="app">
    <!-- Pet Header -->
    <header class="pet-header">
      <a href="pets.html" class="back-button">‚Üê</a>
      <div class="pet-avatar" id="pet-avatar">üêæ</div>
      <h1 class="pet-name" id="pet-name">Loading...</h1>
      <p class="pet-type" id="pet-type"></p>
    </header>

    <!-- Today's Tasks -->
    <section class="tasks-section">
      <h2>üìã Today's Care</h2>
      <div class="task-list" id="task-list">
        <div class="loading-state">
          <p>Loading tasks...</p>
        </div>
      </div>
    </section>

    <!-- Fun Fact -->
    <div class="fun-fact">
      <div class="fun-fact-icon">üí°</div>
      <p id="fun-fact-text">Loading a fun fact...</p>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
      <a href="memories.html" class="quick-action">
        <div class="quick-action-icon">üì∏</div>
        <div class="quick-action-label">Add Memory</div>
      </a>
      <a href="#" class="quick-action" id="edit-link">
        <div class="quick-action-icon">üìù</div>
        <div class="quick-action-label">Edit Pet</div>
      </a>
      <a href="#" class="quick-action" id="delete-link">
        <div class="quick-action-icon">üóëÔ∏è</div>
        <div class="quick-action-label">Remove Pet</div>
      </a>
    </div>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
      <a href="today.html" class="nav-item">
        <span class="nav-icon">üìã</span>
        <span class="nav-label">Today</span>
      </a>
      <a href="pets.html" class="nav-item active">
        <span class="nav-icon">üêæ</span>
        <span class="nav-label">Pets</span>
      </a>
      <a href="family.html" class="nav-item">
        <span class="nav-icon">üë®‚Äçüë©‚Äçüëß</span>
        <span class="nav-label">Family</span>
      </a>
    </nav>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js?v=3"></script>
  <script src="app.js?v=7"></script>
  <script>
    let currentPetId = null;

    // Check auth
    if (!requireAuth()) {
      // Redirect handled by requireAuth
    } else {
      init();
    }

    async function init() {
      currentPetId = getUrlParam('id');
      console.log('Pet ID from URL:', currentPetId);

      const family = getCurrentFamily();
      console.log('Current family:', family);

      if (!currentPetId || currentPetId.trim() === '') {
        alert('No pet ID in URL');
        window.location.href = 'index.html';
        return;
      }

      if (!family) {
        alert('No family logged in');
        window.location.href = 'login.html';
        return;
      }

      // Set up edit link
      document.getElementById('edit-link').href = `edit-pet.html?id=${currentPetId}`;

      // Set up delete handler
      document.getElementById('delete-link').addEventListener('click', async (e) => {
        e.preventDefault();
        if (confirm('Are you sure you want to remove this pet?')) {
          await deletePetFromFirestore(currentPetId);
          window.location.href = 'index.html';
        }
      });

      await renderPetDetailAsync();
    }

    async function renderPetDetailAsync() {
      let pet;
      try {
        pet = await getPetFromFirestore(currentPetId);
      } catch (error) {
        console.error('Error fetching pet:', error);
        alert('Error loading pet: ' + error.message);
        return;
      }

      if (!pet) {
        console.log('Pet not found for ID:', currentPetId);
        alert('Pet not found. Returning to home.');
        window.location.href = 'index.html';
        return;
      }

      const config = PET_CONFIG[pet.type] || PET_CONFIG.dog;

      // Update header
      const header = document.querySelector('.pet-header');
      if (header) {
        header.style.background = `linear-gradient(135deg, ${config.color} 0%, ${lightenColor(config.color)} 100%)`;
      }

      const avatarEl = document.getElementById('pet-avatar');
      const nameEl = document.getElementById('pet-name');
      const typeEl = document.getElementById('pet-type');

      if (avatarEl) avatarEl.textContent = config.emoji;
      if (nameEl) nameEl.textContent = pet.name;
      if (typeEl) typeEl.textContent = pet.breed || config.name;

      // Render tasks
      await renderTasksAsync(pet);

      // Render fun fact
      renderFunFact(pet.type);
    }

    async function renderTasksAsync(pet) {
      const container = document.getElementById('task-list');
      if (!container) return;

      let html = '';
      const customTasks = pet.customTasks || [];

      // If no tasks array, nothing to show
      if (!pet.tasks || pet.tasks.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:#7A7A7A;padding:20px;">No tasks set up yet. Tap Edit Pet to add some!</p>';
        return;
      }

      let tasksShown = 0;

      for (const taskId of pet.tasks) {
        // Find task in customTasks array (new format)
        const taskData = customTasks.find(ct => ct.id === taskId);

        if (!taskData) {
          // Legacy support: check old TASK_CONFIG (always show daily)
          const legacyTask = TASK_CONFIG[taskId];
          if (!legacyTask) continue;

          tasksShown++;
          const completion = await getTaskCompletionDetails(pet.id, taskId);
          const isComplete = !!completion;
          const isPending = completion && completion.status === 'pending';
          const hintText = (pet.taskHints && pet.taskHints[taskId]) || legacyTask.time;

          let statusText = escapeHtml(hintText);
          let statusClass = '';
          let checkMark = '';

          if (isPending) {
            statusText = `Pending approval (${completion.completedByName}) ‚è≥`;
            statusClass = 'pending';
            checkMark = '‚è≥';
          } else if (isComplete) {
            statusText = `Done by ${completion.completedByName} ‚ú®`;
            statusClass = 'completed';
            checkMark = '‚úì';
          }

          html += `
            <button class="task-button ${statusClass}"
                    data-task-id="${taskId}"
                    data-hint="${escapeHtml(hintText)}"
                    data-requires-approval="false"
                    onclick="handleTaskClick(this, '${pet.id}', '${taskId}')">
              <div class="task-icon">${legacyTask.icon}</div>
              <div class="task-content">
                <div class="task-name">${escapeHtml(legacyTask.name)}</div>
                <div class="task-time">${statusText}</div>
              </div>
              <div class="task-check">${checkMark}</div>
            </button>
          `;
          continue;
        }

        // Check if task should show today
        if (!shouldShowTaskToday(taskData)) {
          continue;
        }

        tasksShown++;

        // New format: task data from customTasks
        const completion = await getTaskCompletionDetails(pet.id, taskId);
        const isComplete = !!completion;
        const isPending = completion && completion.status === 'pending';
        const requiresApproval = taskData.requiresApproval || false;
        const reminderTime = taskData.reminderTime || '';
        const overdue = !isComplete && !isPending && isTaskOverdue(reminderTime);

        const hint = taskData.details || 'Tap when done!';
        const timeDisplay = reminderTime ? formatTime(reminderTime) : '';

        let statusText = escapeHtml(hint);
        let statusClass = '';
        let checkMark = '';

        if (isPending) {
          statusText = `Pending approval (${completion.completedByName}) ‚è≥`;
          statusClass = 'pending';
          checkMark = '‚è≥';
        } else if (isComplete) {
          statusText = `Done by ${completion.completedByName} ‚ú®`;
          statusClass = 'completed';
          checkMark = '‚úì';
        } else if (overdue) {
          statusClass = 'overdue';
          statusText = `‚ö†Ô∏è Overdue! Was due at ${timeDisplay}`;
        } else if (timeDisplay) {
          statusText = `‚è∞ ${timeDisplay} ‚Ä¢ ${escapeHtml(hint)}`;
        }

        const approvalBadge = requiresApproval ? '<span class="approval-badge">Needs OK</span>' : '';

        html += `
          <button class="task-button ${statusClass}"
                  data-task-id="${taskId}"
                  data-hint="${escapeHtml(hint)}"
                  data-requires-approval="${requiresApproval}"
                  onclick="handleTaskClick(this, '${pet.id}', '${taskId}')">
            <div class="task-icon">${taskData.icon}</div>
            <div class="task-content">
              <div class="task-name">${escapeHtml(taskData.name)}${approvalBadge}</div>
              <div class="task-time">${statusText}</div>
            </div>
            <div class="task-check">${checkMark}</div>
          </button>
        `;
      }

      if (tasksShown === 0) {
        html = '<p style="text-align:center;color:#7A7A7A;padding:20px;">No tasks scheduled for today! üéâ</p>';
      }

      container.innerHTML = html;
    }

    async function handleTaskClick(buttonEl, petId, taskId) {
      const wasPending = buttonEl.classList.contains('pending');
      const wasComplete = buttonEl.classList.contains('completed');
      const hint = buttonEl.dataset.hint;
      const requiresApproval = buttonEl.dataset.requiresApproval === 'true';

      // Get current member info
      const member = getCurrentMember();
      const memberName = member ? member.name : 'Someone';
      const isParent = member ? member.isParent : false;

      const timeEl = buttonEl.querySelector('.task-time');
      const checkEl = buttonEl.querySelector('.task-check');

      // If pending and parent clicks, they're approving
      if (wasPending && isParent) {
        buttonEl.classList.remove('pending');
        buttonEl.classList.add('completed');
        timeEl.textContent = `Approved ‚ú®`;
        checkEl.textContent = '‚úì';
        showCelebration();

        toggleTaskInFirestore(petId, taskId, requiresApproval).catch(err => {
          console.error('Error approving task:', err);
          buttonEl.classList.remove('completed');
          buttonEl.classList.add('pending');
          timeEl.textContent = `Pending approval ‚è≥`;
          checkEl.textContent = '‚è≥';
        });
        return;
      }

      // If already complete or pending, toggle off
      if (wasComplete || wasPending) {
        buttonEl.classList.remove('completed', 'pending');
        timeEl.textContent = hint;
        checkEl.textContent = '';

        toggleTaskInFirestore(petId, taskId, requiresApproval).catch(err => {
          console.error('Error toggling task:', err);
          // Revert
          if (wasComplete) {
            buttonEl.classList.add('completed');
            timeEl.textContent = `Done by ${memberName} ‚ú®`;
            checkEl.textContent = '‚úì';
          } else {
            buttonEl.classList.add('pending');
            timeEl.textContent = `Pending approval ‚è≥`;
            checkEl.textContent = '‚è≥';
          }
        });
        return;
      }

      // Marking as complete
      const needsApproval = requiresApproval && !isParent;

      if (needsApproval) {
        buttonEl.classList.add('pending');
        timeEl.textContent = `Pending approval (${memberName}) ‚è≥`;
        checkEl.textContent = '‚è≥';
      } else {
        buttonEl.classList.add('completed');
        timeEl.textContent = `Done by ${memberName} ‚ú®`;
        checkEl.textContent = '‚úì';
        showCelebration();
      }

      toggleTaskInFirestore(petId, taskId, requiresApproval).catch(err => {
        console.error('Error saving task:', err);
        buttonEl.classList.remove('completed', 'pending');
        timeEl.textContent = hint;
        checkEl.textContent = '';
      });
    }

    function renderFunFact(petType) {
      const container = document.getElementById('fun-fact-text');
      if (!container) return;

      const facts = FUN_FACTS[petType] || FUN_FACTS.dog;
      const randomFact = facts[Math.floor(Math.random() * facts.length)];

      container.innerHTML = `<strong>Did you know?</strong><br>${randomFact}`;
    }

    function getUrlParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatTime(time24) {
      if (!time24) return '';
      const [hours, minutes] = time24.split(':').map(Number);
      const ampm = hours >= 12 ? 'PM' : 'AM';
      const hours12 = hours % 12 || 12;
      return `${hours12}:${minutes.toString().padStart(2, '0')} ${ampm}`;
    }

    function isTaskOverdue(reminderTime) {
      if (!reminderTime) return false;
      const now = new Date();
      const [hours, minutes] = reminderTime.split(':').map(Number);
      const taskTime = new Date();
      taskTime.setHours(hours, minutes, 0, 0);
      return now > taskTime;
    }

    function lightenColor(hex) {
      return hex + '99';
    }
  </script>
</body>
</html>
